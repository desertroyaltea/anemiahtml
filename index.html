<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MyAnemia</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="MyAnemia">
    <link rel="apple-touch-icon" href="logo.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        [lang="en"] body { font-family: 'Inter', sans-serif; }
        [lang="ar"] body { font-family: 'Tajawal', sans-serif; }
        
        /* Animated Gradient Background */
        body {
            background: linear-gradient(135deg, #0891b2 0%, #06b6d4 50%, #22d3ee 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
        }
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        /* Glassmorphism */
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
        }
        
        .glass-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        /* Blood Drop Loading Animation */
        .blood-drop {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            animation: drip 1.5s ease-in-out infinite;
            position: relative;
        }
        .blood-drop::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            top: 10px;
            left: 15px;
        }
        @keyframes drip {
            0%, 100% { transform: rotate(-45deg) translateY(0); }
            50% { transform: rotate(-45deg) translateY(10px); }
        }
        
        /* Micro-interactions */
        .btn-press:active { transform: scale(0.95); }
        .card-hover:hover { transform: translateY(-4px); transition: all 0.3s ease; }
        
        /* Progress Ring */
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        /* Swipe indicator */
        .swipe-actions {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0 1rem;
            background: linear-gradient(to left, #dc2626, transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        /* RTL Support */
        [dir="rtl"] .swipe-actions { right: auto; left: 0; background: linear-gradient(to right, #dc2626, transparent); }
        [dir="rtl"] .ltr-icon { display: none; }
        [dir="rtl"] .rtl-icon { display: block !important; }
        [dir="ltr"] .rtl-icon { display: none; }
        
        /* Confetti canvas */
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        
        /* Pull to refresh */
        .pull-refresh-indicator {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            transition: all 0.3s;
        }
        
        /* Photo quality indicators */
        .quality-good { border: 3px solid #10b981; }
        .quality-bad { border: 3px solid #dc2626; }
        
        /* Achievement badge animation */
        @keyframes badgePop {
            0% { transform: scale(0) rotate(0deg); }
            50% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        .badge-appear { animation: badgePop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        
        /* Seasonal themes */
        .theme-ramadan { filter: hue-rotate(45deg); }
        
        /* No scrollbar for galleries */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Health score gauge */
        .score-gauge {
            background: conic-gradient(
                #10b981 0deg,
                #10b981 calc(var(--score) * 3.6deg),
                #e5e7eb calc(var(--score) * 3.6deg),
                #e5e7eb 360deg
            );
            border-radius: 50%;
        }
        
        /* Onboarding overlay */
        .onboarding-overlay {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
        }
        
        /* Trend arrow */
        .trend-up { color: #10b981; }
        .trend-down { color: #dc2626; }
        .trend-stable { color: #f59e0b; }
    </style>
</head>
<body class="text-gray-800">
    <canvas id="confetti-canvas"></canvas>

    <!-- Language & Theme Switcher -->
    <div class="fixed top-4 right-4 z-50 flex gap-2">
        <button id="theme-toggle" class="glass-card w-10 h-10 rounded-full shadow-md flex items-center justify-center text-cyan-700 font-bold text-lg btn-press">
            ğŸŒ™
        </button>
        <button id="lang-switcher-btn" class="glass-card w-10 h-10 rounded-full shadow-md flex items-center justify-center text-cyan-700 font-bold text-lg btn-press">
            E
        </button>
    </div>

    <!-- Pull to Refresh Indicator -->
    <div id="pull-refresh" class="pull-refresh-indicator">
        <div class="glass-card rounded-full p-3">
            <svg class="w-6 h-6 animate-spin text-cyan-600" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
    </div>

    <!-- Main content -->
    <main class="max-w-xl mx-auto p-4 md:p-6 pb-40">
        <!-- Dashboard View -->
        <div id="dashboard-view" class="view">
            <!-- Logo & Streak -->
            <div class="flex justify-between items-center mb-6">
                <img src="logo.png" alt="MyAnemia Logo" class="w-20 h-20 rounded-full shadow-lg" onerror="this.onerror=null;this.src='https://placehold.co/100x100/0891b2/FFFFFF?text=ğŸ©¸';">
                <div id="streak-counter" class="glass-card px-4 py-2 rounded-full">
                    <span class="text-2xl">ğŸ”¥</span>
                    <span class="font-bold text-gray-700">0</span>
                </div>
            </div>
            
            <header class="mb-6">
                <h1 data-key="dashboardTitle" class="text-3xl font-bold text-white drop-shadow-lg">Dashboard</h1>
                <p data-key="dashboardSubtitle" class="text-white/90 drop-shadow">Your health summary at a glance.</p>
            </header>

            <!-- Health Score -->
            <div class="glass-card p-6 rounded-3xl shadow-lg mb-6 card-hover">
                <h2 data-key="healthScore" class="font-semibold text-gray-700 text-sm mb-3">Health Score</h2>
                <div class="flex items-center justify-center gap-6">
                    <div class="score-gauge w-32 h-32 flex items-center justify-center" style="--score: 75">
                        <div class="bg-white w-24 h-24 rounded-full flex items-center justify-center">
                            <span id="health-score-value" class="text-3xl font-bold text-cyan-600">75</span>
                        </div>
                    </div>
                    <div class="flex-1">
                        <p id="health-score-text" class="text-sm text-gray-600">Keep tracking regularly!</p>
                        <div id="badges-display" class="flex gap-2 mt-2 flex-wrap"></div>
                    </div>
                </div>
            </div>

            <!-- Latest Reading with Comparison -->
            <div class="glass-card p-6 rounded-3xl shadow-lg mb-6 card-hover">
                <div class="flex justify-between items-center mb-2">
                    <h2 data-key="latestReading" class="font-semibold text-gray-700 text-lg">Latest Reading</h2>
                    <span id="trend-indicator" class="text-2xl"></span>
                </div>
                <div id="latest-reading-dashboard" class="text-center py-4">
                    <p data-key="noReadingsYet" class="text-gray-500">No readings yet. Tap the camera to start!</p>
                </div>
                <div id="comparison-view" class="mt-4 pt-4 border-t border-gray-200 hidden">
                    <div class="grid grid-cols-2 gap-4 text-center text-sm">
                        <div>
                            <p class="text-gray-500" data-key="vsLastWeek">vs Last Week</p>
                            <p id="week-comparison" class="font-bold text-lg"></p>
                        </div>
                        <div>
                            <p class="text-gray-500" data-key="vsLastMonth">vs Last Month</p>
                            <p id="month-comparison" class="font-bold text-lg"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Goal Progress -->
            <div id="goal-section" class="glass-card p-6 rounded-3xl shadow-lg mb-6 card-hover">
                <h2 data-key="goalProgress" class="font-semibold text-gray-700 text-lg mb-3">Goal Progress</h2>
                <div id="goal-content">
                    <button id="set-goal-btn" class="w-full bg-cyan-600 text-white py-3 rounded-xl font-semibold btn-press">
                        <span data-key="setGoal">Set Your Goal</span>
                    </button>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="glass-card p-4 rounded-3xl shadow-lg text-center card-hover">
                    <h3 data-key="avg7days" class="font-semibold text-gray-600 text-sm">Average (7 days)</h3>
                    <p id="avg-7-days" class="text-2xl font-bold text-cyan-600 mt-2">-</p>
                </div>
                <div class="glass-card p-4 rounded-3xl shadow-lg text-center card-hover">
                    <h3 data-key="totalReadings" class="font-semibold text-gray-600 text-sm">Total Readings</h3>
                    <p id="total-readings" class="text-2xl font-bold text-cyan-600 mt-2">0</p>
                </div>
            </div>

            <!-- Smart Recommendations -->
            <div id="recommendations-section" class="glass-card p-6 rounded-3xl shadow-lg mb-6 card-hover hidden">
                <h2 data-key="recommendations" class="font-semibold text-gray-700 text-lg mb-3">ğŸ“‹ Recommendations</h2>
                <div id="recommendations-content" class="space-y-2"></div>
            </div>

            <!-- Trend Predictions -->
            <div id="prediction-section" class="glass-card p-6 rounded-3xl shadow-lg mb-6 card-hover hidden">
                <h2 data-key="trendPrediction" class="font-semibold text-gray-700 text-lg mb-3">ğŸ”® Trend Prediction</h2>
                <p id="prediction-text" class="text-gray-600"></p>
            </div>

            <!-- Educational Articles -->
            <div class="mt-8">
                <h2 data-key="educationTitle" class="text-xl font-bold text-white drop-shadow-lg mb-4 px-1">Anemia Education</h2>
                <div id="article-gallery" class="flex overflow-x-auto -mx-4 px-4 space-x-4 pb-4 no-scrollbar">
                    <!-- Generated by JS -->
                </div>
            </div>
        </div>

        <!-- History View -->
        <div id="history-view" class="view hidden">
            <header class="mb-6">
                <h1 data-key="historyTitle" class="text-3xl font-bold text-white drop-shadow-lg">Reading History</h1>
                <button id="export-btn" class="mt-2 glass-card px-4 py-2 rounded-xl font-semibold text-cyan-700 btn-press">
                    ğŸ“„ <span data-key="exportData">Export Data</span>
                </button>
            </header>
            <div id="history-cards" class="space-y-4"></div>
        </div>

        <!-- Progress View -->
        <div id="progress-view" class="view hidden">
            <header class="mb-6">
                <h1 data-key="progressTitle" class="text-3xl font-bold text-white drop-shadow-lg">Progress</h1>
            </header>
            <div class="glass-card p-6 rounded-3xl shadow-lg mb-6">
                <canvas id="progress-chart"></canvas>
            </div>
            <!-- Photo Gallery -->
            <div id="photo-gallery" class="glass-card p-6 rounded-3xl shadow-lg">
                <h2 data-key="photoGallery" class="font-semibold text-gray-700 text-lg mb-4">Photo Timeline</h2>
                <div id="photo-grid" class="grid grid-cols-3 gap-2"></div>
            </div>
        </div>

        <!-- Insights View -->
        <div id="insights-view" class="view hidden">
            <header class="mb-6">
                <h1 data-key="insightsTitle" class="text-3xl font-bold text-white drop-shadow-lg">Insights</h1>
            </header>
            <div id="insights-content" class="glass-card p-6 rounded-3xl shadow-lg space-y-4"></div>
        </div>

        <!-- Article View -->
        <div id="article-view" class="view hidden">
            <header class="mb-6 flex items-center justify-between">
                <button id="back-to-dashboard-btn" class="glass-card p-3 rounded-xl text-cyan-600 btn-press">
                    <svg class="w-6 h-6 ltr-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                    <svg class="w-6 h-6 rtl-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                </button>
                <h1 id="article-title" class="text-xl font-bold text-white drop-shadow flex-1 text-center">Article</h1>
                <div class="w-14"></div>
            </header>
            <img id="article-image" src="" alt="" class="w-full h-48 object-cover rounded-3xl mb-4 shadow-lg" onerror="this.style.display='none';">
            <div id="article-content" class="glass-card p-6 rounded-3xl shadow-lg space-y-4 leading-relaxed text-gray-600"></div>
            <div class="glass-card p-6 rounded-3xl shadow-lg mt-4">
                <button id="article-bookmark-btn" class="w-full bg-cyan-600 text-white py-3 rounded-xl font-semibold btn-press">
                    â­ <span data-key="bookmarkArticle">Bookmark</span>
                </button>
            </div>
        </div>
    </main>

    <!-- Navigation Footer -->
    <footer id="main-footer" class="fixed bottom-0 left-0 right-0 max-w-xl mx-auto glass-nav border-t border-gray-200">
        <nav class="flex justify-around items-center h-20">
            <button data-view="dashboard-view" class="nav-button nav-active text-center text-gray-500 btn-press">
                <svg class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                <p data-key="navDashboard" class="text-xs font-medium mt-1">Dashboard</p>
            </button>
            <button data-view="history-view" class="nav-button text-center text-gray-500 btn-press">
                <svg class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <p data-key="navHistory" class="text-xs font-medium mt-1">History</p>
            </button>
            <button id="camera-button" class="text-white bg-gradient-to-br from-cyan-500 to-cyan-700 rounded-full w-16 h-16 flex items-center justify-center -mt-8 shadow-xl btn-press">
                <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            </button>
            <button data-view="progress-view" class="nav-button text-center text-gray-500 btn-press">
                <svg class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
                <p data-key="navProgress" class="text-xs font-medium mt-1">Progress</p>
            </button>
            <button data-view="insights-view" class="nav-button text-center text-gray-500 btn-press">
                <svg class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                <p data-key="navInsights" class="text-xs font-medium mt-1">Insights</p>
            </button>
        </nav>
    </footer>
    
    <!-- MODALS -->
    
    <!-- Camera Modal -->
    <div id="camera-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-md p-6 rounded-3xl">
            <h2 data-key="modalNewReading" class="text-xl font-bold mb-4">New Reading</h2>
            <div id="camera-preview" class="hidden mb-4">
                <video id="camera-stream" class="w-full rounded-xl" autoplay playsinline></video>
                <div class="mt-4 flex gap-2">
                    <button id="capture-photo-btn" class="flex-1 bg-cyan-600 text-white py-3 rounded-xl font-semibold btn-press">
                        ğŸ“¸ <span data-key="capturePhoto">Capture</span>
                    </button>
                    <button id="stop-camera-btn" class="bg-gray-300 text-gray-700 px-4 py-3 rounded-xl font-semibold btn-press">
                        <span data-key="cancel">Cancel</span>
                    </button>
                </div>
            </div>
            <div id="camera-options" class="flex gap-4 mb-4">
                <button id="use-camera-btn" class="flex-1 text-center cursor-pointer block bg-gradient-to-br from-cyan-50 to-cyan-100 text-gray-700 py-6 px-4 rounded-2xl border-2 border-dashed border-cyan-300 hover:border-cyan-500 transition-all btn-press">
                    <svg class="h-8 w-8 mx-auto text-cyan-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    <span data-key="modalUseCamera" class="mt-2 block font-semibold">Use Camera</span>
                </button>
                <label for="upload-input-modal" class="flex-1 text-center cursor-pointer block bg-gradient-to-br from-purple-50 to-purple-100 text-gray-700 py-6 px-4 rounded-2xl border-2 border-dashed border-purple-300 hover:border-purple-500 transition-all btn-press">
                    <svg class="h-8 w-8 mx-auto text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    <span data-key="modalUpload" class="mt-2 block font-semibold">Upload</span>
                </label>
            </div>
            <input type="file" accept="image/*" id="upload-input-modal" class="hidden">
            <button id="close-modal-btn" class="mt-4 w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold btn-press">
                <span data-key="cancel">Cancel</span>
            </button>
        </div>
    </div>
    
    <!-- Crop Modal -->
    <div id="crop-modal" class="hidden fixed inset-0 bg-black z-50 flex flex-col p-4">
        <div class="w-full max-w-md mx-auto my-auto glass-card p-6 rounded-3xl">
            <h2 data-key="modalAdjustImage" class="text-xl font-bold mb-2">Adjust Image</h2>
            <p data-key="modalAdjustInfo" class="text-sm text-gray-500 mb-4">Focus on the lower eyelid region.</p>
            <div id="photo-quality-warning" class="hidden mb-4 p-3 bg-yellow-100 border border-yellow-300 rounded-xl">
                <p class="text-sm text-yellow-800">âš ï¸ <span data-key="photoQualityWarning">Image quality may be low. Try better lighting.</span></p>
            </div>
            <div class="cropper-container bg-gray-200 rounded-xl overflow-hidden">
                <img id="image-to-crop" src="">
            </div>
            <div class="flex gap-4 mt-4">
                <button id="back-crop-btn" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold btn-press">
                    <span data-key="back">Back</span>
                </button>
                <button id="confirm-crop-btn" class="flex-1 bg-cyan-600 text-white py-3 rounded-xl font-semibold btn-press">
                    <span data-key="confirm">Confirm</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Analysis Spinner Modal -->
    <div id="analysis-spinner-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-md p-8 rounded-3xl text-center">
            <div class="flex flex-col items-center justify-center space-y-4">
                <div class="blood-drop"></div>
                <span id="loader-text-modal" class="text-lg font-semibold text-gray-700" data-key="analyzing">Analyzing...</span>
            </div>
        </div>
    </div>
    
    <!-- Error Modal -->
    <div id="error-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-md p-6 rounded-3xl text-center">
            <div class="text-6xl mb-4">ğŸ˜”</div>
            <h2 data-key="errorTitle" class="text-xl font-bold mt-4">Oops!</h2>
            <p id="error-message" class="text-gray-600 mt-2" data-key="errorUnknown">Something went wrong.</p>
            <p class="text-sm text-gray-500 mt-2" data-key="errorTryAgain">Don't worry, let's try again!</p>
            <button id="close-error-btn" class="mt-6 w-full bg-gradient-to-br from-red-500 to-red-600 text-white py-3 rounded-xl font-semibold btn-press">
                <span data-key="close">Close</span>
            </button>
        </div>
    </div>
    
    <!-- Success Modal -->
    <div id="success-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-md p-6 rounded-3xl text-center">
            <div class="text-6xl mb-4">ğŸ‰</div>
            <h2 id="success-title" class="text-2xl font-bold text-cyan-600">Great News!</h2>
            <p id="success-message" class="text-gray-600 mt-3"></p>
            <button id="close-success-btn" class="mt-6 w-full bg-gradient-to-br from-cyan-500 to-cyan-600 text-white py-3 rounded-xl font-semibold btn-press">
                <span data-key="continue">Continue</span>
            </button>
        </div>
    </div>
    
    <!-- Goal Setting Modal -->
    <div id="goal-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-md p-6 rounded-3xl">
            <h2 data-key="setYourGoal" class="text-xl font-bold mb-4">Set Your Goal</h2>
            <p class="text-gray-600 mb-4" data-key="goalDescription">What Hb level would you like to reach?</p>
            <input type="number" id="goal-input" class="w-full p-3 border-2 border-gray-300 rounded-xl mb-4" placeholder="e.g., 14" step="0.1" min="10" max="18">
            <div class="flex gap-4">
                <button id="cancel-goal-btn" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold btn-press">
                    <span data-key="cancel">Cancel</span>
                </button>
                <button id="save-goal-btn" class="flex-1 bg-cyan-600 text-white py-3 rounded-xl font-semibold btn-press">
                    <span data-key="save">Save</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Note Modal -->
    <div id="note-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-md p-6 rounded-3xl">
            <h2 data-key="addNote" class="text-xl font-bold mb-4">Add Note</h2>
            <textarea id="note-input" class="w-full p-3 border-2 border-gray-300 rounded-xl mb-4 h-32" placeholder="e.g., After taking iron supplement"></textarea>
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-2" data-key="quickTags">Quick Tags:</p>
                <div class="flex flex-wrap gap-2">
                    <button class="tag-btn px-3 py-1 bg-cyan-100 text-cyan-700 rounded-full text-sm btn-press" data-tag="Morning">ğŸŒ… Morning</button>
                    <button class="tag-btn px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm btn-press" data-tag="After Meal">ğŸ½ï¸ After Meal</button>
                    <button class="tag-btn px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm btn-press" data-tag="Supplement">ğŸ’Š Supplement</button>
                    <button class="tag-btn px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm btn-press" data-tag="Feeling Tired">ğŸ˜´ Tired</button>
                </div>
            </div>
            <div class="flex gap-4">
                <button id="cancel-note-btn" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold btn-press">
                    <span data-key="cancel">Cancel</span>
                </button>
                <button id="save-note-btn" class="flex-1 bg-cyan-600 text-white py-3 rounded-xl font-semibold btn-press" data-timestamp="">
                    <span data-key="save">Save</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-md p-6 rounded-3xl text-center">
            <div class="text-5xl mb-4">âš ï¸</div>
            <h2 data-key="deleteConfirm" class="text-xl font-bold">Delete Reading?</h2>
            <p class="text-gray-600 mt-2" data-key="deleteWarning">This action cannot be undone.</p>
            <div class="flex gap-4 mt-6">
                <button id="cancel-delete-btn" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold btn-press">
                    <span data-key="cancel">Cancel</span>
                </button>
                <button id="confirm-delete-btn" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-semibold btn-press" data-timestamp="">
                    <span data-key="delete">Delete</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Onboarding Overlay -->
    <div id="onboarding" class="hidden fixed inset-0 onboarding-overlay z-[100] flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-md p-8 rounded-3xl text-center">
            <div id="onboarding-content"></div>
            <div class="flex gap-4 mt-6">
                <button id="onboarding-skip" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold btn-press">
                    <span data-key="skip">Skip</span>
                </button>
                <button id="onboarding-next" class="flex-1 bg-cyan-600 text-white py-3 rounded-xl font-semibold btn-press">
                    <span data-key="next">Next</span>
                </button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIG ---
        const BACKEND_API_URL = "https://your-render-url.onrender.com/api/analyze"; // UPDATE THIS
        
        // --- TRANSLATIONS ---
        const translations = {
            en: {
                dashboardTitle: 'Dashboard', dashboardSubtitle: 'Your health summary at a glance.',
                latestReading: 'Latest Reading', noReadingsYet: 'No readings yet. Tap the camera to start!',
                avg7days: 'Average (7 days)', totalReadings: 'Total Readings',
                historyTitle: 'Reading History', progressTitle: 'Progress', chartLabel: 'Estimated Hb (g/dL)',
                insightsTitle: 'Insights', navDashboard: 'Dashboard', navHistory: 'History', 
                navProgress: 'Progress', navInsights: 'Insights',
                modalNewReading: 'New Reading', modalUseCamera: 'Use Camera', modalUpload: 'Upload',
                cancel: 'Cancel', modalAdjustImage: 'Adjust Image', 
                modalAdjustInfo: 'Focus on the lower eyelid region.',
                back: 'Back', confirm: 'Confirm', analyzing: 'Analyzing...', 
                errorTitle: 'Oops!', errorUnknown: 'Something went wrong.', 
                errorTryAgain: "Don't worry, let's try again!", close: 'Close',
                severeAnemia: 'Severe Anemia', moderateAnemia: 'Moderate Anemia', 
                mildAnemia: 'Mild Anemia', likelyNormal: 'Healthy Range',
                educationTitle: 'Anemia Education', healthScore: 'Health Score',
                vsLastWeek: 'vs Last Week', vsLastMonth: 'vs Last Month',
                goalProgress: 'Goal Progress', setGoal: 'Set Your Goal',
                recommendations: 'Recommendations', trendPrediction: 'Trend Prediction',
                exportData: 'Export Data', photoGallery: 'Photo Timeline',
                bookmarkArticle: 'Bookmark', capturePhoto: 'Capture',
                photoQualityWarning: 'Image quality may be low. Try better lighting.',
                continue: 'Continue', setYourGoal: 'Set Your Goal',
                goalDescription: 'What Hb level would you like to reach?',
                save: 'Save', addNote: 'Add Note', quickTags: 'Quick Tags:',
                deleteConfirm: 'Delete Reading?', deleteWarning: 'This action cannot be undone.',
                delete: 'Delete', skip: 'Skip', next: 'Next',
                onboarding1Title: 'Welcome to MyAnemia! ğŸ©¸',
                onboarding1Text: 'Track your hemoglobin levels and manage anemia with ease.',
                onboarding2Title: 'Take Perfect Photos ğŸ“¸',
                onboarding2Text: 'Focus on your lower eyelid in good lighting for accurate results.',
                onboarding3Title: 'Track Your Progress ğŸ“ˆ',
                onboarding3Text: 'View trends, set goals, and celebrate improvements!',
                streak: 'Day Streak',
                articles: [
                    { id: 'what-is-anemia', imageUrl: 'anemia-explained.png', title: 'Understanding Anemia', readTime: '3 min', content: `<h3 class="text-lg font-bold text-gray-800">What is Anemia?</h3><p>Anemia is a condition where your blood lacks enough healthy red blood cells or hemoglobin...</p>` },
                    { id: 'anemia-types', imageUrl: 'anemia-types.png', title: 'Types of Anemia', readTime: '4 min', content: `<h3 class="text-lg font-bold text-gray-800">Common Types</h3><p>Iron-deficiency anemia is the most common type worldwide...</p>` },
                    { id: 'anemia-diet', imageUrl: 'anemia-diet.png', title: 'Nutrition Guide', readTime: '5 min', content: `<h3 class="text-lg font-bold text-gray-800">Foods That Help</h3><p>Iron-rich foods include lean meat, spinach, lentils...</p>` },
                    { id: 'anemia-symptoms', imageUrl: 'anemia-symptoms.png', title: 'Common Symptoms', readTime: '3 min', content: `<h3 class="text-lg font-bold text-gray-800">Warning Signs</h3><p>Fatigue, pale skin, and shortness of breath are common...</p>` },
                    { id: 'living-with-anemia', imageUrl: 'anemia-wellness.png', title: 'Living Well', readTime: '6 min', content: `<h3 class="text-lg font-bold text-gray-800">Daily Management</h3><p>With proper care, you can lead a full and active life...</p>` }
                ]
            },
            ar: {
                dashboardTitle: 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…', dashboardSubtitle: 'Ù…Ù„Ø®Øµ ØµØ­ØªÙƒ ÙÙŠ Ù„Ù…Ø­Ø©.',
                latestReading: 'Ø¢Ø®Ø± Ù‚Ø±Ø§Ø¡Ø©', noReadingsYet: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø§Øª Ø¨Ø¹Ø¯. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ø¨Ø¯Ø¡!',
                avg7days: 'Ù…ØªÙˆØ³Ø· (7 Ø£ÙŠØ§Ù…)', totalReadings: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª',
                historyTitle: 'Ø³Ø¬Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª', progressTitle: 'Ø§Ù„ØªÙ‚Ø¯Ù…', chartLabel: 'Ø§Ù„Ù‡ÙŠÙ…ÙˆØ¬Ù„ÙˆØ¨ÙŠÙ† Ø§Ù„Ù…Ù‚Ø¯Ø± (Ø¬Ù…/Ø¯ÙŠØ³ÙŠÙ„ØªØ±)',
                insightsTitle: 'Ø¥Ø­ØµØ§Ø¡Ø§Øª', navDashboard: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', navHistory: 'Ø§Ù„Ø³Ø¬Ù„',
                navProgress: 'Ø§Ù„ØªÙ‚Ø¯Ù…', navInsights: 'Ø¥Ø­ØµØ§Ø¡Ø§Øª',
                modalNewReading: 'Ù‚Ø±Ø§Ø¡Ø© Ø¬Ø¯ÙŠØ¯Ø©', modalUseCamera: 'Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§', modalUpload: 'Ø±ÙØ¹ ØµÙˆØ±Ø©',
                cancel: 'Ø¥Ù„ØºØ§Ø¡', modalAdjustImage: 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©',
                modalAdjustInfo: 'Ø±ÙƒØ² Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¬ÙÙ† Ø§Ù„Ø³ÙÙ„ÙŠ.',
                back: 'Ø±Ø¬ÙˆØ¹', confirm: 'ØªØ£ÙƒÙŠØ¯', analyzing: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...',
                errorTitle: 'Ø¹Ø°Ø±Ø§Ù‹!', errorUnknown: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…Ø§.',
                errorTryAgain: 'Ù„Ø§ ØªÙ‚Ù„Ù‚ØŒ Ù„Ù†Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰!', close: 'Ø¥ØºÙ„Ø§Ù‚',
                severeAnemia: 'ÙÙ‚Ø± Ø¯Ù… Ø­Ø§Ø¯', moderateAnemia: 'ÙÙ‚Ø± Ø¯Ù… Ù…ØªÙˆØ³Ø·',
                mildAnemia: 'ÙÙ‚Ø± Ø¯Ù… Ø®ÙÙŠÙ', likelyNormal: 'Ù†Ø·Ø§Ù‚ ØµØ­ÙŠ',
                educationTitle: 'Ø§Ù„ØªØ«Ù‚ÙŠÙ Ø­ÙˆÙ„ ÙÙ‚Ø± Ø§Ù„Ø¯Ù…', healthScore: 'Ù†Ù‚Ø§Ø· Ø§Ù„ØµØ­Ø©',
                vsLastWeek: 'Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¶ÙŠ', vsLastMonth: 'Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ',
                goalProgress: 'ØªÙ‚Ø¯Ù… Ø§Ù„Ù‡Ø¯Ù', setGoal: 'Ø­Ø¯Ø¯ Ù‡Ø¯ÙÙƒ',
                recommendations: 'Ø§Ù„ØªÙˆØµÙŠØ§Øª', trendPrediction: 'ØªÙˆÙ‚Ø¹ Ø§Ù„Ø§ØªØ¬Ø§Ù‡',
                exportData: 'ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', photoGallery: 'Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±',
                bookmarkArticle: 'Ø­ÙØ¸', capturePhoto: 'Ø§Ù„ØªÙ‚Ø§Ø·',
                photoQualityWarning: 'Ù‚Ø¯ ØªÙƒÙˆÙ† Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø© Ù…Ù†Ø®ÙØ¶Ø©. Ø¬Ø±Ø¨ Ø¥Ø¶Ø§Ø¡Ø© Ø£ÙØ¶Ù„.',
                continue: 'Ù…ØªØ§Ø¨Ø¹Ø©', setYourGoal: 'Ø­Ø¯Ø¯ Ù‡Ø¯ÙÙƒ',
                goalDescription: 'Ù…Ø§ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù‡ÙŠÙ…ÙˆØ¬Ù„ÙˆØ¨ÙŠÙ† Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡ØŸ',
                save: 'Ø­ÙØ¸', addNote: 'Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø©', quickTags: 'Ø¹Ù„Ø§Ù…Ø§Øª Ø³Ø±ÙŠØ¹Ø©:',
                deleteConfirm: 'Ø­Ø°Ù Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©ØŸ', deleteWarning: 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.',
                delete: 'Ø­Ø°Ù', skip: 'ØªØ®Ø·ÙŠ', next: 'Ø§Ù„ØªØ§Ù„ÙŠ',
                onboarding1Title: 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ÙŠ! ğŸ©¸',
                onboarding1Text: 'ØªØªØ¨Ø¹ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ù‡ÙŠÙ…ÙˆØ¬Ù„ÙˆØ¨ÙŠÙ† ÙˆØ¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø± Ø§Ù„Ø¯Ù… Ø¨Ø³Ù‡ÙˆÙ„Ø©.',
                onboarding2Title: 'Ø§Ù„ØªÙ‚Ø· ØµÙˆØ±Ø§Ù‹ Ù…Ø«Ø§Ù„ÙŠØ© ğŸ“¸',
                onboarding2Text: 'Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙÙ† Ø§Ù„Ø³ÙÙ„ÙŠ ÙÙŠ Ø¥Ø¶Ø§Ø¡Ø© Ø¬ÙŠØ¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ Ø¯Ù‚ÙŠÙ‚Ø©.',
                onboarding3Title: 'ØªØªØ¨Ø¹ ØªÙ‚Ø¯Ù…Ùƒ ğŸ“ˆ',
                onboarding3Text: 'Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§ØªØŒ Ø­Ø¯Ø¯ Ø§Ù„Ø£Ù‡Ø¯Ø§ÙØŒ ÙˆØ§Ø­ØªÙÙ„ Ø¨Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª!',
                streak: 'Ø£ÙŠØ§Ù… Ù…ØªØªØ§Ù„ÙŠØ©',
                articles: [
                    { id: 'what-is-anemia', imageUrl: 'anemia-explained.png', title: 'ÙÙ‡Ù… ÙÙ‚Ø± Ø§Ù„Ø¯Ù…', readTime: '3 Ø¯Ù‚Ø§Ø¦Ù‚', content: `<h3 class="text-lg font-bold text-gray-800 rtl:text-right">Ù…Ø§ Ù‡Ùˆ ÙÙ‚Ø± Ø§Ù„Ø¯Ù…ØŸ</h3><p class="rtl:text-right">ÙÙ‚Ø± Ø§Ù„Ø¯Ù… Ù‡Ùˆ Ø­Ø§Ù„Ø© ÙŠÙØªÙ‚Ø± ÙÙŠÙ‡Ø§ Ø¯Ù…Ùƒ Ø¥Ù„Ù‰ Ù…Ø§ ÙŠÙƒÙÙŠ Ù…Ù† Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ø¯Ù… Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ Ø§Ù„Ø³Ù„ÙŠÙ…Ø©...</p>` },
                    { id: 'anemia-types', imageUrl: 'anemia-types.png', title: 'Ø£Ù†ÙˆØ§Ø¹ ÙÙ‚Ø± Ø§Ù„Ø¯Ù…', readTime: '4 Ø¯Ù‚Ø§Ø¦Ù‚', content: `<h3 class="text-lg font-bold text-gray-800 rtl:text-right">Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©</h3><p class="rtl:text-right">ÙÙ‚Ø± Ø§Ù„Ø¯Ù… Ø§Ù„Ù†Ø§Ø¬Ù… Ø¹Ù† Ù†Ù‚Øµ Ø§Ù„Ø­Ø¯ÙŠØ¯ Ù‡Ùˆ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ù†ØªØ´Ø§Ø±Ø§Ù‹...</p>` },
                    { id: 'anemia-diet', imageUrl: 'anemia-diet.png', title: 'Ø¯Ù„ÙŠÙ„ Ø§Ù„ØªØºØ°ÙŠØ©', readTime: '5 Ø¯Ù‚Ø§Ø¦Ù‚', content: `<h3 class="text-lg font-bold text-gray-800 rtl:text-right">Ø§Ù„Ø£Ø·Ø¹Ù…Ø© Ø§Ù„Ù…ÙÙŠØ¯Ø©</h3><p class="rtl:text-right">ØªØ´Ù…Ù„ Ø§Ù„Ø£Ø·Ø¹Ù…Ø© Ø§Ù„ØºÙ†ÙŠØ© Ø¨Ø§Ù„Ø­Ø¯ÙŠØ¯ Ø§Ù„Ù„Ø­ÙˆÙ… Ø§Ù„Ø®Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø¯Ù‡ÙˆÙ†ØŒ Ø§Ù„Ø³Ø¨Ø§Ù†Ø®ØŒ Ø§Ù„Ø¹Ø¯Ø³...</p>` },
                    { id: 'anemia-symptoms', imageUrl: 'anemia-symptoms.png', title: 'Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©', readTime: '3 Ø¯Ù‚Ø§Ø¦Ù‚', content: `<h3 class="text-lg font-bold text-gray-800 rtl:text-right">Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ­Ø°ÙŠØ±</h3><p class="rtl:text-right">Ø§Ù„Ø¥Ø±Ù‡Ø§Ù‚ ÙˆØ´Ø­ÙˆØ¨ Ø§Ù„Ø¬Ù„Ø¯ ÙˆØ¶ÙŠÙ‚ Ø§Ù„ØªÙ†ÙØ³ Ø´Ø§Ø¦Ø¹Ø©...</p>` },
                    { id: 'living-with-anemia', imageUrl: 'anemia-wellness.png', title: 'Ø§Ù„Ø¹ÙŠØ´ Ø¨Ø´ÙƒÙ„ Ø¬ÙŠØ¯', readTime: '6 Ø¯Ù‚Ø§Ø¦Ù‚', content: `<h3 class="text-lg font-bold text-gray-800 rtl:text-right">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3><p class="rtl:text-right">Ù…Ø¹ Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø£Ù† ØªØ¹ÙŠØ´ Ø­ÙŠØ§Ø© ÙƒØ§Ù…Ù„Ø© ÙˆÙ†Ø´Ø·Ø©...</p>` }
                ]
            }
        };

        // --- DOM ELEMENTS ---
        const mainFooter = document.getElementById('main-footer');
        const views = document.querySelectorAll('.view');
        const navButtons = document.querySelectorAll('.nav-button');
        const cameraButton = document.getElementById('camera-button');
        const cameraModal = document.getElementById('camera-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const analysisSpinnerModal = document.getElementById('analysis-spinner-modal');
        const errorModal = document.getElementById('error-modal');
        const closeErrorBtn = document.getElementById('close-error-btn');
        const successModal = document.getElementById('success-modal');
        const closeSuccessBtn = document.getElementById('close-success-btn');
        const cropModal = document.getElementById('crop-modal');
        const imageToCrop = document.getElementById('image-to-crop');
        const confirmCropBtn = document.getElementById('confirm-crop-btn');
        const backCropBtn = document.getElementById('back-crop-btn');
        const uploadInputModal = document.getElementById('upload-input-modal');
        const langSwitcherBtn = document.getElementById('lang-switcher-btn');
        const themeToggle = document.getElementById('theme-toggle');
        const articleGallery = document.getElementById('article-gallery');
        const articleView = document.getElementById('article-view');
        const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
        
        // Camera elements
        const useCameraBtn = document.getElementById('use-camera-btn');
        const cameraPreview = document.getElementById('camera-preview');
        const cameraOptions = document.getElementById('camera-options');
        const cameraStream = document.getElementById('camera-stream');
        const capturePhotoBtn = document.getElementById('capture-photo-btn');
        const stopCameraBtn = document.getElementById('stop-camera-btn');
        
        let appState = { 
            history: [], 
            language: 'en', 
            darkMode: false,
            goal: null,
            notes: {},
            bookmarks: [],
            streak: 0,
            badges: []
        };
        let progressChart = null;
        let cropper = null;
        let currentStream = null;
        let pullStartY = 0;
        let isPulling = false;
        
        // --- UTILITY FUNCTIONS ---
        const vibrate = (pattern = 10) => {
            if ('vibrate' in navigator) navigator.vibrate(pattern);
        };
        
        const triggerConfetti = () => {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
        };
        
        const calculateStreak = () => {
            if (appState.history.length === 0) return 0;
            let streak = 1;
            const sorted = [...appState.history].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            for (let i = 0; i < sorted.length - 1; i++) {
                const current = new Date(sorted[i].timestamp);
                const previous = new Date(sorted[i + 1].timestamp);
                const diffDays = Math.floor((current - previous) / (1000 * 60 * 60 * 24));
                if (diffDays === 1) streak++;
                else break;
            }
            return streak;
        };
        
        const checkBadges = () => {
            const badges = [];
            if (appState.history.length >= 1) badges.push({ id: 'first', emoji: 'ğŸ¯', name: 'First Reading' });
            if (appState.streak >= 7) badges.push({ id: 'week', emoji: 'âš¡', name: 'Week Warrior' });
            if (appState.history.length >= 30) badges.push({ id: 'month', emoji: 'ğŸ†', name: 'Monthly Master' });
            
            const improving = appState.history.slice(0, 5).every((r, i, arr) => 
                i === 0 || r.hb_value >= arr[i - 1].hb_value
            );
            if (improving && appState.history.length >= 5) badges.push({ id: 'trend', emoji: 'ğŸ“ˆ', name: 'Trend Master' });
            
            if (appState.history.length > 0 && appState.history[0].hb_value >= 12) {
                badges.push({ id: 'healthy', emoji: 'ğŸ¦¸', name: 'Health Hero' });
            }
            
            return badges;
        };
        
        const calculateHealthScore = () => {
            let score = 50; // Base score
            
            // Consistency bonus
            if (appState.history.length >= 7) score += 15;
            if (appState.history.length >= 14) score += 10;
            
            // Streak bonus
            if (appState.streak >= 3) score += 10;
            if (appState.streak >= 7) score += 10;
            
            // Latest reading bonus
            if (appState.history.length > 0) {
                const latest = appState.history[0].hb_value;
                if (latest >= 12) score += 20;
                else if (latest >= 10) score += 10;
            }
            
            // Trend bonus
            if (appState.history.length >= 3) {
                const recent = appState.history.slice(0, 3);
                const isImproving = recent[0].hb_value > recent[2].hb_value;
                if (isImproving) score += 15;
            }
            
            return Math.min(100, score);
        };
        
        // --- LANGUAGE & THEME ---
        const setLanguage = (lang) => {
            appState.language = lang;
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            
            langSwitcherBtn.textContent = lang === 'en' ? 'Ø¹' : 'E';
            
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.dataset.key;
                if (translations[lang][key] && typeof translations[lang][key] === 'string') {
                    el.textContent = translations[lang][key];
                }
            });
            
            localStorage.setItem('myAnemia-lang', lang);
            renderArticleGallery();
            updateAllViews();
        };
        
        const toggleLanguage = () => setLanguage(appState.language === 'en' ? 'ar' : 'en');
        
        const toggleTheme = () => {
            appState.darkMode = !appState.darkMode;
            themeToggle.textContent = appState.darkMode ? 'â˜€ï¸' : 'ğŸŒ™';
            document.body.classList.toggle('theme-ramadan', appState.darkMode);
            localStorage.setItem('myAnemia-theme', appState.darkMode);
        };
        
        // --- ARTICLE RENDERING ---
        const renderArticleGallery = () => {
            const lang = appState.language;
            const articles = translations[lang].articles;
            articleGallery.innerHTML = articles.map(article => {
                const isBookmarked = appState.bookmarks.includes(article.id);
                return `
                <div class="article-card flex-shrink-0 w-56 glass-card rounded-3xl shadow-lg cursor-pointer overflow-hidden card-hover" data-article-id="${article.id}">
                    <div class="relative">
                        <img src="${article.imageUrl}" alt="${article.title}" class="w-full h-32 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x200/06b6d4/FFFFFF?text=${encodeURIComponent(article.title)}';">
                        ${isBookmarked ? '<div class="absolute top-2 right-2 bg-yellow-400 rounded-full p-2">â­</div>' : ''}
                        <div class="absolute bottom-2 left-2 bg-black/60 text-white text-xs px-2 py-1 rounded-full">â±ï¸ ${article.readTime}</div>
                    </div>
                    <p class="p-4 font-semibold text-sm text-gray-800 leading-snug">${article.title}</p>
                </div>`;
            }).join('');
        };
        
        const showArticle = (articleId) => {
            const lang = appState.language;
            const article = translations[lang].articles.find(a => a.id === articleId);
            if (!article) return;
            
            document.getElementById('article-title').textContent = article.title;
            document.getElementById('article-image').src = article.imageUrl;
            document.getElementById('article-content').innerHTML = article.content;
            
            const bookmarkBtn = document.getElementById('article-bookmark-btn');
            const isBookmarked = appState.bookmarks.includes(articleId);
            bookmarkBtn.innerHTML = isBookmarked ? 'â­ Bookmarked' : 'â­ Bookmark';
            bookmarkBtn.onclick = () => {
                if (appState.bookmarks.includes(articleId)) {
                    appState.bookmarks = appState.bookmarks.filter(id => id !== articleId);
                } else {
                    appState.bookmarks.push(articleId);
                }
                saveState();
                showArticle(articleId);
                renderArticleGallery();
                vibrate(20);
            };
            
            showView('article-view');
        };
        
        // --- VIEW MANAGEMENT ---
        const showView = (viewId) => {
            views.forEach(v => v.classList.add('hidden'));
            const targetView = document.getElementById(viewId);
            if(targetView) targetView.classList.remove('hidden');
            
            navButtons.forEach(b => b.classList.toggle('nav-active', b.dataset.view === viewId));
            mainFooter.style.display = (viewId === 'article-view') ? 'none' : '';
            
            if (viewId === 'progress-view') {
                setTimeout(() => {
                    updateChart();
                    updatePhotoGallery();
                }, 50);
            }
        };
        
        // --- DATA FUNCTIONS ---
        const getHbClassification = (hb) => {
            if (hb < 8) return { color: "text-red-500", textKey: "severeAnemia" };
            if (hb < 10) return { color: "text-orange-500", textKey: "moderateAnemia" };
            if (hb < 12) return { color: "text-yellow-500", textKey: "mildAnemia" };
            return { color: "text-green-500", textKey: "likelyNormal" };
        };
        
        const saveState = () => {
            localStorage.setItem('myAnemia-state', JSON.stringify(appState));
        };
        
        const loadState = () => {
            const saved = localStorage.getItem('myAnemia-state');
            if (saved) {
                const parsed = JSON.parse(saved);
                appState = { ...appState, ...parsed };
            }
        };
        
        // --- UPDATE FUNCTIONS ---
        const updateAllViews = () => {
            const lang = appState.language;
            
            // Update streak
            appState.streak = calculateStreak();
            document.getElementById('streak-counter').innerHTML = `
                <span class="text-2xl">ğŸ”¥</span>
                <span class="font-bold text-gray-700">${appState.streak}</span>
            `;
            
            // Update health score
            const healthScore = calculateHealthScore();
            document.getElementById('health-score-value').textContent = healthScore;
            document.querySelector('.score-gauge').style.setProperty('--score', healthScore);
            
            // Update badges
            appState.badges = checkBadges();
            const badgesDisplay = document.getElementById('badges-display');
            badgesDisplay.innerHTML = appState.badges.map(b => 
                `<span class="badge-appear text-2xl" title="${b.name}">${b.emoji}</span>`
            ).join('');
            
            // Update total readings
            document.getElementById('total-readings').textContent = appState.history.length;
            
            // Latest reading
            const latestReadingDiv = document.getElementById('latest-reading-dashboard');
            if (appState.history.length > 0) {
                const latest = appState.history[0];
                const { color, textKey } = getHbClassification(latest.hb_value);
                const text = translations[lang][textKey];
                
                latestReadingDiv.innerHTML = `
                    <p class="text-5xl font-bold ${color}">${latest.hb_value.toFixed(2)} 
                        <span class="text-3xl font-medium text-gray-500">g/dL</span>
                    </p>
                    <p class="text-md font-semibold ${color} mt-2">${text}</p>
                `;
                
                // Show comparison
                document.getElementById('comparison-view').classList.remove('hidden');
                updateComparison();
                
                // Update trend indicator
                if (appState.history.length >= 2) {
                    const current = latest.hb_value;
                    const previous = appState.history[1].hb_value;
                    const trendIndicator = document.getElementById('trend-indicator');
                    if (current > previous) {
                        trendIndicator.innerHTML = 'ğŸ“ˆ';
                        trendIndicator.className = 'text-2xl trend-up';
                    } else if (current < previous) {
                        trendIndicator.innerHTML = 'ğŸ“‰';
                        trendIndicator.className = 'text-2xl trend-down';
                    } else {
                        trendIndicator.innerHTML = 'â¡ï¸';
                        trendIndicator.className = 'text-2xl trend-stable';
                    }
                }
            } else {
                latestReadingDiv.innerHTML = `<p class="text-gray-500">${translations[lang].noReadingsYet}</p>`;
                document.getElementById('comparison-view').classList.add('hidden');
            }
            
            // 7-day average
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const recentReadings = appState.history.filter(r => new Date(r.timestamp) > sevenDaysAgo);
            if (recentReadings.length > 0) {
                const avg = recentReadings.reduce((s, r) => s + r.hb_value, 0) / recentReadings.length;
                document.getElementById('avg-7-days').textContent = avg.toFixed(2);
            } else {
                document.getElementById('avg-7-days').textContent = '-';
            }
            
            // Update goal
            updateGoalDisplay();
            
            // Update recommendations
            updateRecommendations();
            
            // Update predictions
            updatePredictions();
            
            // Update history
            updateHistory();
            
            // Update insights
            updateInsights();
        };
        
        const updateComparison = () => {
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const weekReading = appState.history.find(r => new Date(r.timestamp) <= weekAgo);
            
            const monthAgo = new Date();
            monthAgo.setMonth(monthAgo.getMonth() - 1);
            const monthReading = appState.history.find(r => new Date(r.timestamp) <= monthAgo);
            
            const latest = appState.history[0];
            
            if (weekReading) {
                const diff = latest.hb_value - weekReading.hb_value;
                const arrow = diff > 0 ? 'â†‘' : diff < 0 ? 'â†“' : 'â†’';
                const color = diff > 0 ? 'text-green-600' : diff < 0 ? 'text-red-600' : 'text-gray-600';
                document.getElementById('week-comparison').innerHTML = `<span class="${color}">${arrow} ${Math.abs(diff).toFixed(1)}</span>`;
            } else {
                document.getElementById('week-comparison').textContent = '-';
            }
            
            if (monthReading) {
                const diff = latest.hb_value - monthReading.hb_value;
                const arrow = diff > 0 ? 'â†‘' : diff < 0 ? 'â†“' : 'â†’';
                const color = diff > 0 ? 'text-green-600' : diff < 0 ? 'text-red-600' : 'text-gray-600';
                document.getElementById('month-comparison').innerHTML = `<span class="${color}">${arrow} ${Math.abs(diff).toFixed(1)}</span>`;
            } else {
                document.getElementById('month-comparison').textContent = '-';
            }
        };
        
        const updateGoalDisplay = () => {
            const goalContent = document.getElementById('goal-content');
            if (appState.goal) {
                const latest = appState.history.length > 0 ? appState.history[0].hb_value : 0;
                const progress = Math.min(100, (latest / appState.goal) * 100);
                goalContent.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-2">
                            <span>Current: ${latest.toFixed(1)}</span>
                            <span>Goal: ${appState.goal}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-gradient-to-r from-cyan-500 to-cyan-600 h-4 rounded-full transition-all" style="width: ${progress}%"></div>
                        </div>
                    </div>
                    <button id="change-goal-btn" class="w-full bg-gray-200 text-gray-700 py-2 rounded-xl text-sm btn-press">
                        Change Goal
                    </button>
                `;
                document.getElementById('change-goal-btn').onclick = () => {
                    document.getElementById('goal-modal').classList.remove('hidden');
                    document.getElementById('goal-input').value = appState.goal;
                };
            }
        };
        
        const updateRecommendations = () => {
            if (appState.history.length === 0) {
                document.getElementById('recommendations-section').classList.add('hidden');
                return;
            }
            
            const latest = appState.history[0].hb_value;
            const recommendations = [];
            
            if (latest < 10) {
                recommendations.push('ğŸ¥© Increase iron-rich foods in your diet');
                recommendations.push('ğŸ’Š Consider iron supplements (consult your doctor)');
                recommendations.push('ğŸŠ Pair iron with vitamin C for better absorption');
            } else if (latest < 12) {
                recommendations.push('ğŸ¥— Maintain a balanced diet with iron sources');
                recommendations.push('ğŸƒ Light exercise can help improve circulation');
            } else {
                recommendations.push('âœ… Great job! Keep maintaining healthy habits');
                recommendations.push('ğŸ“Š Continue regular monitoring');
            }
            
            const recSection = document.getElementById('recommendations-section');
            recSection.classList.remove('hidden');
            document.getElementById('recommendations-content').innerHTML = recommendations.map(r => 
                `<p class="text-sm text-gray-700">â€¢ ${r}</p>`
            ).join('');
        };
        
        const updatePredictions = () => {
            if (appState.history.length < 3) {
                document.getElementById('prediction-section').classList.add('hidden');
                return;
            }
            
            const recent = appState.history.slice(0, 5);
            const trend = recent[0].hb_value - recent[recent.length - 1].hb_value;
            const avgChange = trend / recent.length;
            
            let prediction = '';
            if (avgChange > 0.1) {
                const weeksToNormal = appState.goal ? Math.ceil((appState.goal - recent[0].hb_value) / avgChange) : null;
                prediction = weeksToNormal ? 
                    `At this rate, you'll reach your goal in approximately ${weeksToNormal} weeks! ğŸ“ˆ` :
                    `Your levels are improving by ${avgChange.toFixed(2)} g/dL per reading. Keep it up! ğŸ“ˆ`;
            } else if (avgChange < -0.1) {
                prediction = `Your levels are declining. Consider consulting your doctor. ğŸ“‰`;
            } else {
                prediction = `Your levels are stable. Consistency is key! â¡ï¸`;
            }
            
            document.getElementById('prediction-section').classList.remove('hidden');
            document.getElementById('prediction-text').textContent = prediction;
        };
        
        const updateHistory = () => {
            const historyCardsDiv = document.getElementById('history-cards');
            historyCardsDiv.innerHTML = '';
            
            if (appState.history.length === 0) {
                historyCardsDiv.innerHTML = `<div class="glass-card text-center p-6 rounded-3xl"><p class="text-gray-500">No readings yet.</p></div>`;
                return;
            }
            
            const locale = appState.language === 'ar' ? 'ar-EG' : 'en-US';
            appState.history.forEach(r => {
                const card = document.createElement('div');
                card.className = 'glass-card p-4 rounded-3xl shadow-md relative card-hover';
                card.style.touchAction = 'pan-y';
                
                const dt = new Date(r.timestamp);
                const { color } = getHbClassification(r.hb_value);
                const note = appState.notes[r.timestamp] || '';
                
                card.innerHTML = `
                    <div class="flex items-center gap-4">
                        <img src="data:image/jpeg;base64,${r.crop_b64}" class="w-24 h-20 object-cover rounded-xl border-2 border-gray-200">
                        <div class="flex-1">
                            <p class="font-semibold text-gray-800">${dt.toLocaleDateString(locale, {year:'numeric',month:'long',day:'numeric'})}</p>
                            <p class="text-xs text-gray-500">${dt.toLocaleTimeString(locale, {hour:'2-digit',minute:'2-digit'})}</p>
                            <p class="text-2xl font-bold ${color} mt-1">${r.hb_value.toFixed(2)} g/dL</p>
                            ${note ? `<p class="text-xs text-gray-600 mt-1">ğŸ“ ${note}</p>` : ''}
                        </div>
                        <div class="flex flex-col gap-2">
                            <button class="note-btn bg-blue-100 text-blue-600 p-2 rounded-lg btn-press" data-timestamp="${r.timestamp}">
                                ğŸ“
                            </button>
                            <button class="delete-btn bg-red-100 text-red-600 p-2 rounded-lg btn-press" data-timestamp="${r.timestamp}">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `;
                
                historyCardsDiv.appendChild(card);
            });
            
            // Add event listeners
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    vibrate(30);
                    const timestamp = btn.dataset.timestamp;
                    document.getElementById('delete-modal').classList.remove('hidden');
                    document.getElementById('confirm-delete-btn').dataset.timestamp = timestamp;
                });
            });
            
            document.querySelectorAll('.note-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    vibrate(10);
                    const timestamp = btn.dataset.timestamp;
                    document.getElementById('note-modal').classList.remove('hidden');
                    document.getElementById('note-input').value = appState.notes[timestamp] || '';
                    document.getElementById('save-note-btn').dataset.timestamp = timestamp;
                });
            });
        };
        
        const updateInsights = () => {
            const insightsContent = document.getElementById('insights-content');
            const lang = appState.language;
            
            if (appState.history.length < 3) {
                insightsContent.innerHTML = `<p class="text-gray-500">Take at least 3 readings to generate insights.</p>`;
                return;
            }
            
            const latest = appState.history[0].hb_value;
            const oldest = appState.history[appState.history.length - 1].hb_value;
            const trend = latest - oldest;
            
            let insightHTML = '';
            if (trend > 0.5) {
                insightHTML = `
                    <div class="text-center">
                        <p class="text-4xl mb-3">ğŸ˜Š</p>
                        <p class="font-semibold text-xl text-green-600">Positive Trend!</p>
                        <p class="text-gray-600 mt-2">Your Hb increased by ${trend.toFixed(2)} g/dL. Keep up the great work!</p>
                    </div>
                `;
            } else if (trend < -0.5) {
                insightHTML = `
                    <div class="text-center">
                        <p class="text-4xl mb-3">ğŸ˜Ÿ</p>
                        <p class="font-semibold text-xl text-red-600">Downward Trend</p>
                        <p class="text-gray-600 mt-2">Your Hb decreased by ${Math.abs(trend).toFixed(2)} g/dL. Consider consulting your doctor.</p>
                    </div>
                `;
            } else {
                insightHTML = `
                    <div class="text-center">
                        <p class="text-4xl mb-3">ğŸ˜</p>
                        <p class="font-semibold text-xl text-blue-600">Stable Levels</p>
                        <p class="text-gray-600 mt-2">Your Hb levels are consistent. Consistency is key!</p>
                    </div>
                `;
            }
            
            insightsContent.innerHTML = insightHTML;
        };
        
        const updateChart = () => {
            const progressView = document.getElementById('progress-view');
            if (progressView.classList.contains('hidden') || appState.history.length === 0) return;
            
            const ctx = document.getElementById('progress-chart').getContext('2d');
            const locale = appState.language === 'ar' ? 'ar-EG' : 'en-US';
            const labels = appState.history.map(r => new Date(r.timestamp).toLocaleDateString(locale)).reverse();
            const data = appState.history.map(r => r.hb_value).reverse();
            
            if (progressChart) progressChart.destroy();
            
            progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: translations[appState.language].chartLabel,
                        data,
                        fill: true,
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6, 182, 212, 0.1)',
                        tension: 0.4,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: Math.max(0, Math.min(...data) - 2),
                            max: Math.max(...data) + 2
                        }
                    }
                }
            });
        };
        
        const updatePhotoGallery = () => {
            const photoGrid = document.getElementById('photo-grid');
            if (appState.history.length === 0) {
                photoGrid.innerHTML = '<p class="text-gray-500 col-span-3 text-center py-8">No photos yet</p>';
                return;
            }
            
            photoGrid.innerHTML = appState.history.slice(0, 12).map(r => `
                <img src="data:image/jpeg;base64,${r.crop_b64}" class="w-full h-24 object-cover rounded-xl border-2 border-gray-200 cursor-pointer card-hover" onclick="window.open(this.src)">
            `).join('');
        };
        
        // --- CAMERA FUNCTIONS ---
        const checkPhotoQuality = (imageElement) => {
            // Simple brightness check
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = imageElement.width;
            canvas.height = imageElement.height;
            ctx.drawImage(imageElement, 0, 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            let brightness = 0;
            
            for (let i = 0; i < data.length; i += 4) {
                brightness += (data[i] + data[i + 1] + data[i + 2]) / 3;
            }
            
            brightness = brightness / (data.length / 4);
            
            if (brightness < 50 || brightness > 230) {
                document.getElementById('photo-quality-warning').classList.remove('hidden');
            } else {
                document.getElementById('photo-quality-warning').classList.add('hidden');
            }
        };
        
        const startCamera = async () => {
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                cameraStream.srcObject = currentStream;
                cameraOptions.classList.add('hidden');
                cameraPreview.classList.remove('hidden');
            } catch (error) {
                alert('Camera access denied or not available');
            }
        };
        
        const stopCamera = () => {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            cameraPreview.classList.add('hidden');
            cameraOptions.classList.remove('hidden');
        };
        
        const capturePhoto = () => {
            const canvas = document.createElement('canvas');
            canvas.width = cameraStream.videoWidth;
            canvas.height = cameraStream.videoHeight;
            canvas.getContext('2d').drawImage(cameraStream, 0, 0);
            
            stopCamera();
            
            const dataUrl = canvas.toDataURL('image/jpeg');
            imageToCrop.src = dataUrl;
            cameraModal.classList.add('hidden');
            cropModal.classList.remove('hidden');
            
            if (cropper) cropper.destroy();
            cropper = new Cropper(imageToCrop, {
                aspectRatio: 16 / 9,
                viewMode: 1,
                dragMode: 'move',
                background: false,
                autoCropArea: 0.8
            });
            
            checkPhotoQuality(imageToCrop);
        };
        
        const handleFileSelect = (file) => {
            if (!file) return;
            const objectURL = URL.createObjectURL(file);
            imageToCrop.src = objectURL;
            cameraModal.classList.add('hidden');
            cropModal.classList.remove('hidden');
            
            if (cropper) cropper.destroy();
            cropper = new Cropper(imageToCrop, {
                aspectRatio: 16 / 9,
                viewMode: 1,
                dragMode: 'move',
                background: false,
                autoCropArea: 0.8
            });
            
            imageToCrop.onload = () => checkPhotoQuality(imageToCrop);
        };
        
        // --- API CALL ---
        const analyzeImage = async (base64Image) => {
            analysisSpinnerModal.classList.remove('hidden');
            vibrate([50, 100, 50]);
            
            try {
                const response = await fetch(BACKEND_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ "image_b64": base64Image })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    throw new Error(errorData.detail || `Server error: ${response.status}`);
                }
                
                const result = await response.json();
                const newReading = {
                    hb_value: result.hb_value,
                    crop_b64: result.crop_b64,
                    timestamp: new Date().toISOString()
                };
                
                const oldBadges = [...appState.badges];
                appState.history.unshift(newReading);
                saveState();
                updateAllViews();
                
                // Check for new badges
                const newBadges = checkBadges();
                const earnedBadges = newBadges.filter(nb => !oldBadges.some(ob => ob.id === nb.id));
                
                // Show success
                analysisSpinnerModal.classList.add('hidden');
                vibrate([100, 50, 100]);
                
                if (newReading.hb_value >= 12 && earnedBadges.length > 0) {
                    triggerConfetti();
                }
                
                const { textKey } = getHbClassification(newReading.hb_value);
                document.getElementById('success-title').textContent = translations[appState.language][textKey];
                document.getElementById('success-message').textContent = `Your hemoglobin level is ${newReading.hb_value.toFixed(2)} g/dL`;
                document.getElementById('success-modal').classList.remove('hidden');
                
                showView('dashboard-view');
                
            } catch (error) {
                console.error("Analysis failed:", error);
                analysisSpinnerModal.classList.add('hidden');
                document.getElementById('error-message').textContent = error.message;
                errorModal.classList.remove('hidden');
                vibrate([200, 100, 200]);
            }
        };
        
        // --- EXPORT DATA ---
        const exportData = () => {
            if (appState.history.length === 0) {
                alert('No data to export');
                return;
            }
            
            let csvContent = "Date,Time,Hemoglobin (g/dL),Note\n";
            appState.history.forEach(r => {
                const dt = new Date(r.timestamp);
                const date = dt.toLocaleDateString();
                const time = dt.toLocaleTimeString();
                const note = appState.notes[r.timestamp] || '';
                csvContent += `${date},${time},${r.hb_value},"${note}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `myanemia_data_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            vibrate(50);
        };
        
        // --- PULL TO REFRESH ---
        const handleTouchStart = (e) => {
            if (window.scrollY === 0 && document.getElementById('dashboard-view').classList.contains('hidden') === false) {
                pullStartY = e.touches[0].clientY;
            }
        };
        
        const handleTouchMove = (e) => {
            if (pullStartY > 0) {
                const currentY = e.touches[0].clientY;
                const diff = currentY - pullStartY;
                
                if (diff > 0 && diff < 100) {
                    document.getElementById('pull-refresh').style.top = `${diff - 60}px`;
                    isPulling = true;
                }
            }
        };
        
        const handleTouchEnd = () => {
            if (isPulling) {
                document.getElementById('pull-refresh').style.top = '-60px';
                updateAllViews();
                vibrate(20);
                isPulling = false;
            }
            pullStartY = 0;
        };
        
        // --- ONBOARDING ---
        const showOnboarding = () => {
            const steps = [
                { title: translations[appState.language].onboarding1Title, text: translations[appState.language].onboarding1Text, emoji: 'ğŸ©¸' },
                { title: translations[appState.language].onboarding2Title, text: translations[appState.language].onboarding2Text, emoji: 'ğŸ“¸' },
                { title: translations[appState.language].onboarding3Title, text: translations[appState.language].onboarding3Text, emoji: 'ğŸ“ˆ' }
            ];
            
            let currentStep = 0;
            const onboarding = document.getElementById('onboarding');
            const content = document.getElementById('onboarding-content');
            
            const renderStep = () => {
                const step = steps[currentStep];
                content.innerHTML = `
                    <div class="text-6xl mb-4">${step.emoji}</div>
                    <h2 class="text-2xl font-bold mb-3">${step.title}</h2>
                    <p class="text-gray-600">${step.text}</p>
                    <div class="flex gap-2 justify-center mt-4">
                        ${steps.map((_, i) => `<div class="w-2 h-2 rounded-full ${i === currentStep ? 'bg-cyan-600' : 'bg-gray-300'}"></div>`).join('')}
                    </div>
                `;
                
                const nextBtn = document.getElementById('onboarding-next');
                nextBtn.textContent = currentStep === steps.length - 1 ? 'Get Started' : 'Next';
            };
            
            renderStep();
            onboarding.classList.remove('hidden');
            
            document.getElementById('onboarding-next').onclick = () => {
                if (currentStep < steps.length - 1) {
                    currentStep++;
                    renderStep();
                    vibrate(10);
                } else {
                    onboarding.classList.add('hidden');
                    localStorage.setItem('myAnemia-onboarded', 'true');
                }
            };
            
            document.getElementById('onboarding-skip').onclick = () => {
                onboarding.classList.add('hidden');
                localStorage.setItem('myAnemia-onboarded', 'true');
            };
        };
        
        // --- EVENT LISTENERS ---
        langSwitcherBtn.addEventListener('click', toggleLanguage);
        themeToggle.addEventListener('click', toggleTheme);
        navButtons.forEach(button => button.addEventListener('click', () => {
            showView(button.dataset.view);
            vibrate(10);
        }));
        
        cameraButton.addEventListener('click', () => {
            cameraModal.classList.remove('hidden');
            vibrate(20);
        });
        
        closeModalBtn.addEventListener('click', () => cameraModal.classList.add('hidden'));
        closeErrorBtn.addEventListener('click', () => errorModal.classList.add('hidden'));
        closeSuccessBtn.addEventListener('click', () => successModal.classList.add('hidden'));
        
        useCameraBtn.addEventListener('click', startCamera);
        stopCameraBtn.addEventListener('click', () => {
            stopCamera();
            cameraModal.classList.add('hidden');
        });
        capturePhotoBtn.addEventListener('click', capturePhoto);
        
        uploadInputModal.addEventListener('change', (event) => handleFileSelect(event.target.files[0]));
        
        backCropBtn.addEventListener('click', () => {
            cropModal.classList.add('hidden');
            cameraModal.classList.remove('hidden');
            if (cropper) cropper.destroy();
            cropper = null;
        });
        
        confirmCropBtn.addEventListener('click', () => {
            if (!cropper) return;
            const croppedCanvas = cropper.getCroppedCanvas({ width: 800, imageSmoothingQuality: 'high' });
            const base64Cropped = croppedCanvas.toDataURL('image/jpeg').split(',')[1];
            cropModal.classList.add('hidden');
            analyzeImage(base64Cropped);
            if (cropper) cropper.destroy();
            cropper = null;
            vibrate(30);
        });
        
        articleGallery.addEventListener('click', (event) => {
            const card = event.target.closest('.article-card');
            if (card && card.dataset.articleId) {
                showArticle(card.dataset.articleId);
                vibrate(10);
            }
        });
        
        backToDashboardBtn.addEventListener('click', () => {
            showView('dashboard-view');
            vibrate(10);
        });
        
        // Goal modal
        document.getElementById('set-goal-btn')?.addEventListener('click', () => {
            document.getElementById('goal-modal').classList.remove('hidden');
            vibrate(10);
        });
        
        document.getElementById('cancel-goal-btn').addEventListener('click', () => {
            document.getElementById('goal-modal').classList.add('hidden');
        });
        
        document.getElementById('save-goal-btn').addEventListener('click', () => {
            const goalValue = parseFloat(document.getElementById('goal-input').value);
            if (goalValue && goalValue >= 10 && goalValue <= 18) {
                appState.goal = goalValue;
                saveState();
                updateAllViews();
                document.getElementById('goal-modal').classList.add('hidden');
                vibrate([50, 50, 50]);
            } else {
                alert('Please enter a valid goal (10-18 g/dL)');
            }
        });
        
        // Note modal
        document.getElementById('cancel-note-btn').addEventListener('click', () => {
            document.getElementById('note-modal').classList.add('hidden');
        });
        
        document.getElementById('save-note-btn').addEventListener('click', () => {
            const timestamp = document.getElementById('save-note-btn').dataset.timestamp;
            const note = document.getElementById('note-input').value;
            if (note.trim()) {
                appState.notes[timestamp] = note.trim();
                saveState();
                updateAllViews();
                document.getElementById('note-modal').classList.add('hidden');
                vibrate(30);
            }
        });
        
        // Quick tag buttons
        document.querySelectorAll('.tag-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tag = btn.dataset.tag;
                const noteInput = document.getElementById('note-input');
                noteInput.value = (noteInput.value + ' ' + tag).trim();
                vibrate(10);
            });
        });
        
        // Delete modal
        document.getElementById('cancel-delete-btn').addEventListener('click', () => {
            document.getElementById('delete-modal').classList.add('hidden');
        });
        
        document.getElementById('confirm-delete-btn').addEventListener('click', () => {
            const timestamp = document.getElementById('confirm-delete-btn').dataset.timestamp;
            appState.history = appState.history.filter(r => r.timestamp !== timestamp);
            delete appState.notes[timestamp];
            saveState();
            updateAllViews();
            document.getElementById('delete-modal').classList.add('hidden');
            vibrate([100, 50, 100]);
        });
        
        // Export button
        document.getElementById('export-btn').addEventListener('click', exportData);
        
        // Pull to refresh
        document.addEventListener('touchstart', handleTouchStart);
        document.addEventListener('touchmove', handleTouchMove);
        document.addEventListener('touchend', handleTouchEnd);
        
        // --- INITIALIZE ---
        const initializeApp = () => {
            loadState();
            
            const savedLang = localStorage.getItem('myAnemia-lang') || 'en';
            setLanguage(savedLang);
            
            const savedTheme = localStorage.getItem('myAnemia-theme') === 'true';
            if (savedTheme) {
                appState.darkMode = true;
                themeToggle.textContent = 'â˜€ï¸';
                document.body.classList.add('theme-ramadan');
            }
            
            updateAllViews();
            
            // Show onboarding for first-time users
            const hasOnboarded = localStorage.getItem('myAnemia-onboarded');
            if (!hasOnboarded) {
                setTimeout(() => showOnboarding(), 500);
            }
        };
        
        initializeApp();
    });
    </script>
</body>
</html>