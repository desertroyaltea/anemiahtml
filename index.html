<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MyAnemia</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="MyAnemia">
    <link rel="apple-touch-icon" href="logo.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        [lang="en"] body { font-family: 'Inter', sans-serif; }
        [lang="ar"] body { font-family: 'Tajawal', sans-serif; }
        body { background: #f8fafc; min-height: 100vh; }
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
        }
        .glass-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.5);
        }
        .blood-drop {
            width: 60px; height: 60px;
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            animation: drip 1.5s ease-in-out infinite;
        }
        @keyframes drip {
            0%, 100% { transform: rotate(-45deg) translateY(0); }
            50% { transform: rotate(-45deg) translateY(10px); }
        }
        .btn-press:active { transform: scale(0.95); }
        .card-hover:hover { transform: translateY(-4px); transition: all 0.3s ease; }
        .nav-active svg, .nav-active p { color: #0891b2; }
        [dir="rtl"] .ltr-icon { display: none; }
        [dir="rtl"] .rtl-icon { display: block !important; }
        [dir="ltr"] .rtl-icon { display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-gray-800">
    <div class="fixed top-4 right-4 z-50">
        <button id="lang-btn" class="glass-card w-10 h-10 rounded-full shadow-md flex items-center justify-center text-cyan-700 font-bold text-lg btn-press">Ø¹</button>
    </div>

    <main class="max-w-xl mx-auto p-4 md:p-6 pb-40">
        <div id="dashboard-view" class="view">
            <div class="flex justify-between items-center mb-6">
                <img src="logo.png" alt="Logo" class="w-20 h-20 rounded-full shadow-lg" onerror="this.style.display='none'">
                <div id="streak" class="glass-card px-4 py-2 rounded-full mt-12">
                    <span class="text-2xl">ğŸ”¥</span>
                    <span class="font-bold text-gray-700">0</span>
                </div>
            </div>
            <header class="mb-6">
                <h1 data-key="dashboardTitle" class="text-3xl font-bold text-gray-800">Dashboard</h1>
                <p data-key="dashboardSubtitle" class="text-gray-600">Your health summary</p>
            </header>
            <div class="glass-card p-6 rounded-3xl shadow-lg mb-6">
                <h2 data-key="latestReading" class="font-semibold text-gray-700 text-lg mb-2">Latest Reading</h2>
                <div id="latest-reading" class="text-center py-4">
                    <p data-key="noReadingsYet" class="text-gray-500">No readings yet</p>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="glass-card p-4 rounded-3xl shadow-lg text-center">
                    <h3 data-key="avg7days" class="font-semibold text-gray-600 text-sm">Average (7 days)</h3>
                    <p id="avg-7" class="text-2xl font-bold text-cyan-600 mt-2">-</p>
                </div>
                <div class="glass-card p-4 rounded-3xl shadow-lg text-center">
                    <h3 data-key="totalReadings" class="font-semibold text-gray-600 text-sm">Total Readings</h3>
                    <p id="total" class="text-2xl font-bold text-cyan-600 mt-2">0</p>
                </div>
            </div>
            <div class="mt-8">
                <h2 data-key="educationTitle" class="text-xl font-bold text-gray-800 mb-4">Anemia Education</h2>
                <div id="articles" class="flex overflow-x-auto -mx-4 px-4 space-x-4 pb-4 no-scrollbar"></div>
            </div>
        </div>

        <div id="history-view" class="view hidden">
            <header class="mb-6">
                <h1 data-key="historyTitle" class="text-3xl font-bold text-gray-800">History</h1>
            </header>
            <div id="history-cards" class="space-y-4"></div>
        </div>

        <div id="progress-view" class="view hidden">
            <header class="mb-6">
                <h1 data-key="progressTitle" class="text-3xl font-bold text-gray-800">Progress</h1>
            </header>
            <div class="glass-card p-6 rounded-3xl shadow-lg">
                <canvas id="chart"></canvas>
            </div>
        </div>

        <div id="insights-view" class="view hidden">
            <header class="mb-6">
                <h1 data-key="insightsTitle" class="text-3xl font-bold text-gray-800">Insights</h1>
            </header>
            <div id="insights" class="glass-card p-6 rounded-3xl shadow-lg"></div>
        </div>

        <div id="article-view" class="view hidden">
            <header class="mb-6 flex items-center justify-between">
                <button id="back-btn" class="glass-card p-3 rounded-xl text-cyan-600 btn-press">
                    <svg class="w-6 h-6 ltr-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
                    <svg class="w-6 h-6 rtl-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
                </button>
                <h1 id="article-title" class="text-xl font-bold text-gray-800 flex-1 text-center">Article</h1>
                <div class="w-14"></div>
            </header>
            <img id="article-img" src="" class="w-full h-48 object-cover rounded-3xl mb-4 shadow-lg">
            <div id="article-content" class="glass-card p-6 rounded-3xl shadow-lg leading-relaxed text-gray-600"></div>
        </div>
    </main>

    <footer class="fixed bottom-0 left-0 right-0 max-w-xl mx-auto glass-nav">
        <nav class="flex justify-around items-center h-20">
            <button data-view="dashboard-view" class="nav-button nav-active text-center text-gray-500 btn-press">
                <svg class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
                <p data-key="navDashboard" class="text-xs font-medium mt-1">Dashboard</p>
            </button>
            <button data-view="history-view" class="nav-button text-center text-gray-500 btn-press">
                <svg class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                <p data-key="navHistory" class="text-xs font-medium mt-1">History</p>
            </button>
            <button id="camera-btn" class="text-white bg-gradient-to-br from-cyan-500 to-cyan-700 rounded-full w-16 h-16 flex items-center justify-center -mt-8 shadow-xl btn-press">
                <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            </button>
            <button data-view="progress-view" class="nav-button text-center text-gray-500 btn-press">
                <svg class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                <p data-key="navProgress" class="text-xs font-medium mt-1">Progress</p>
            </button>
            <button data-view="insights-view" class="nav-button text-center text-gray-500 btn-press">
                <svg class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                <p data-key="navInsights" class="text-xs font-medium mt-1">Insights</p>
            </button>
        </nav>
    </footer>

    <div id="camera-modal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-md p-6 rounded-3xl">
            <h2 data-key="modalNewReading" class="text-xl font-bold mb-4">New Reading</h2>
            <div class="flex gap-4 mb-4">
                <label for="camera-input" class="flex-1 text-center cursor-pointer block bg-gradient-to-br from-cyan-50 to-cyan-100 text-gray-700 py-6 px-4 rounded-2xl border-2 border-dashed border-cyan-300 btn-press">
                    <svg class="h-8 w-8 mx-auto text-cyan-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    <span data-key="modalUseCamera" class="mt-2 block font-semibold">Use Camera</span>
                </label>
                <label for="upload-input" class="flex-1 text-center cursor-pointer block bg-gradient-to-br from-purple-50 to-purple-100 text-gray-700 py-6 px-4 rounded-2xl border-2 border-dashed border-purple-300 btn-press">
                    <svg class="h-8 w-8 mx-auto text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                    <span data-key="modalUpload" class="mt-2 block font-semibold">Upload</span>
                </label>
            </div>
            <input type="file" accept="image/*" capture="environment" id="camera-input" class="hidden">
            <input type="file" accept="image/*" id="upload-input" class="hidden">
            <button id="close-modal" class="mt-4 w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold btn-press">
                <span data-key="cancel">Cancel</span>
            </button>
        </div>
    </div>

    <div id="crop-modal" class="hidden fixed inset-0 bg-black z-50 flex flex-col p-4">
        <div class="w-full max-w-md mx-auto my-auto glass-card p-6 rounded-3xl">
            <h2 data-key="modalAdjustImage" class="text-xl font-bold mb-2">Adjust Image</h2>
            <p data-key="modalAdjustInfo" class="text-sm text-gray-500 mb-4">Focus on the eyelid</p>
            <div class="cropper-container bg-gray-200 rounded-xl overflow-hidden">
                <img id="image-to-crop" src="">
            </div>
            <div class="flex gap-4 mt-4">
                <button id="back-crop" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold btn-press">
                    <span data-key="back">Back</span>
                </button>
                <button id="confirm-crop" class="flex-1 bg-cyan-600 text-white py-3 rounded-xl font-semibold btn-press">
                    <span data-key="confirm">Confirm</span>
                </button>
            </div>
        </div>
    </div>

    <div id="loading-modal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-md p-8 rounded-3xl text-center">
            <div class="flex flex-col items-center space-y-4">
                <div class="blood-drop"></div>
                <span data-key="analyzing" class="text-lg font-semibold text-gray-700">Analyzing...</span>
            </div>
        </div>
    </div>

    <div id="error-modal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-md p-6 rounded-3xl text-center">
            <div class="text-6xl mb-4">ğŸ˜”</div>
            <h2 data-key="errorTitle" class="text-xl font-bold mt-4">Oops!</h2>
            <p id="error-msg" class="text-gray-600 mt-2">Something went wrong</p>
            <button id="close-error" class="mt-6 w-full bg-red-600 text-white py-3 rounded-xl font-semibold btn-press">
                <span data-key="close">Close</span>
            </button>
        </div>
    </div>

    <script>
    (function() {
        'use strict';
        
        const API_URL = "https://your-render-url.onrender.com/api/analyze";
        
        const translations = {
            en: {
                dashboardTitle: 'Dashboard', dashboardSubtitle: 'Your health summary', latestReading: 'Latest Reading',
                noReadingsYet: 'No readings yet', avg7days: 'Average (7 days)', totalReadings: 'Total Readings',
                historyTitle: 'History', progressTitle: 'Progress', insightsTitle: 'Insights',
                navDashboard: 'Dashboard', navHistory: 'History', navProgress: 'Progress', navInsights: 'Insights',
                modalNewReading: 'New Reading', modalUseCamera: 'Use Camera', modalUpload: 'Upload',
                cancel: 'Cancel', modalAdjustImage: 'Adjust Image', modalAdjustInfo: 'Focus on the eyelid',
                back: 'Back', confirm: 'Confirm', analyzing: 'Analyzing...', errorTitle: 'Oops!', close: 'Close',
                educationTitle: 'Anemia Education',
                articles: [
                    {id: 'a1', img: 'anemia-explained.png', title: 'Understanding Anemia', time: '3 min',
                     content: '<h3 class="text-lg font-bold mb-3">Red Blood Cells</h3><p>Anemia is when your blood lacks healthy red blood cells or hemoglobin.</p>'},
                    {id: 'a2', img: 'anemia-types.png', title: 'Types of Anemia', time: '4 min',
                     content: '<h3 class="text-lg font-bold mb-3">Different Types</h3><p>Iron-deficiency is most common worldwide.</p>'},
                    {id: 'a3', img: 'anemia-diet.png', title: 'Nutrition Guide', time: '5 min',
                     content: '<h3 class="text-lg font-bold mb-3">Foods That Help</h3><p>Eat iron-rich foods like meat, spinach, lentils.</p>'}
                ]
            },
            ar: {
                dashboardTitle: 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…', dashboardSubtitle: 'Ù…Ù„Ø®Øµ ØµØ­ØªÙƒ', latestReading: 'Ø¢Ø®Ø± Ù‚Ø±Ø§Ø¡Ø©',
                noReadingsYet: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø§Øª', avg7days: 'Ù…ØªÙˆØ³Ø· (7 Ø£ÙŠØ§Ù…)', totalReadings: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª',
                historyTitle: 'Ø§Ù„Ø³Ø¬Ù„', progressTitle: 'Ø§Ù„ØªÙ‚Ø¯Ù…', insightsTitle: 'Ø¥Ø­ØµØ§Ø¡Ø§Øª',
                navDashboard: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', navHistory: 'Ø§Ù„Ø³Ø¬Ù„', navProgress: 'Ø§Ù„ØªÙ‚Ø¯Ù…', navInsights: 'Ø¥Ø­ØµØ§Ø¡Ø§Øª',
                modalNewReading: 'Ù‚Ø±Ø§Ø¡Ø© Ø¬Ø¯ÙŠØ¯Ø©', modalUseCamera: 'Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§', modalUpload: 'Ø±ÙØ¹ ØµÙˆØ±Ø©',
                cancel: 'Ø¥Ù„ØºØ§Ø¡', modalAdjustImage: 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©', modalAdjustInfo: 'Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙÙ†',
                back: 'Ø±Ø¬ÙˆØ¹', confirm: 'ØªØ£ÙƒÙŠØ¯', analyzing: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...', errorTitle: 'Ø¹Ø°Ø±Ø§Ù‹!', close: 'Ø¥ØºÙ„Ø§Ù‚',
                educationTitle: 'Ø§Ù„ØªØ«Ù‚ÙŠÙ Ø­ÙˆÙ„ ÙÙ‚Ø± Ø§Ù„Ø¯Ù…',
                articles: [
                    {id: 'a1', img: 'anemia-explained.png', title: 'ÙÙ‡Ù… ÙÙ‚Ø± Ø§Ù„Ø¯Ù…', time: '3 Ø¯Ù‚Ø§Ø¦Ù‚',
                     content: '<h3 class="text-lg font-bold mb-3 text-right">Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ø¯Ù… Ø§Ù„Ø­Ù…Ø±Ø§Ø¡</h3><p class="text-right">ÙÙ‚Ø± Ø§Ù„Ø¯Ù… Ù‡Ùˆ Ù†Ù‚Øµ ÙÙŠ Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ø¯Ù… Ø§Ù„Ø­Ù…Ø±Ø§Ø¡.</p>'},
                    {id: 'a2', img: 'anemia-types.png', title: 'Ø£Ù†ÙˆØ§Ø¹ ÙÙ‚Ø± Ø§Ù„Ø¯Ù…', time: '4 Ø¯Ù‚Ø§Ø¦Ù‚',
                     content: '<h3 class="text-lg font-bold mb-3 text-right">Ø£Ù†ÙˆØ§Ø¹ Ù…Ø®ØªÙ„ÙØ©</h3><p class="text-right">Ù†Ù‚Øµ Ø§Ù„Ø­Ø¯ÙŠØ¯ Ù‡Ùˆ Ø§Ù„Ø£ÙƒØ«Ø± Ø´ÙŠÙˆØ¹Ø§Ù‹.</p>'},
                    {id: 'a3', img: 'anemia-diet.png', title: 'Ø¯Ù„ÙŠÙ„ Ø§Ù„ØªØºØ°ÙŠØ©', time: '5 Ø¯Ù‚Ø§Ø¦Ù‚',
                     content: '<h3 class="text-lg font-bold mb-3 text-right">Ø£Ø·Ø¹Ù…Ø© Ù…ÙÙŠØ¯Ø©</h3><p class="text-right">ØªÙ†Ø§ÙˆÙ„ Ø§Ù„Ø£Ø·Ø¹Ù…Ø© Ø§Ù„ØºÙ†ÙŠØ© Ø¨Ø§Ù„Ø­Ø¯ÙŠØ¯.</p>'}
                ]
            }
        };
        
        let state = {history: [], lang: 'en'};
        let cropper = null;
        let chart = null;
        
        function $(id) {return document.getElementById(id);}
        function $$(sel) {return document.querySelectorAll(sel);}
        
        function setLang(lang) {
            state.lang = lang;
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            $('lang-btn').textContent = lang === 'en' ? 'Ø¹' : 'E';
            $$('[data-key]').forEach(el => {
                const key = el.dataset.key;
                if (translations[lang][key]) el.textContent = translations[lang][key];
            });
            renderArticles();
            updateViews();
            localStorage.setItem('lang', lang);
        }
        
        function renderArticles() {
            const arts = translations[state.lang].articles;
            $('articles').innerHTML = arts.map(a => `
                <div class="article-card flex-shrink-0 w-56 glass-card rounded-3xl shadow-lg cursor-pointer overflow-hidden card-hover" data-id="${a.id}">
                    <div class="relative">
                        <img src="${a.img}" class="w-full h-32 object-cover" onerror="this.src='https://placehold.co/400x200/06b6d4/FFF'">
                        <div class="absolute bottom-2 left-2 bg-black/60 text-white text-xs px-2 py-1 rounded-full">â±ï¸ ${a.time}</div>
                    </div>
                    <p class="p-4 font-semibold text-sm text-gray-800">${a.title}</p>
                </div>
            `).join('');
        }
        
        function showView(id) {
            $$('.view').forEach(v => v.classList.add('hidden'));
            $(id).classList.remove('hidden');
            $$('.nav-button').forEach(b => b.classList.toggle('nav-active', b.dataset.view === id));
            if (id === 'progress-view') setTimeout(updateChart, 50);
        }
        
        function updateViews() {
            $('total').textContent = state.history.length;
            if (state.history.length > 0) {
                const latest = state.history[0];
                $('latest-reading').innerHTML = `<p class="text-5xl font-bold text-cyan-600">${latest.hb.toFixed(2)} <span class="text-3xl text-gray-500">g/dL</span></p>`;
                const week = state.history.filter(r => new Date(r.time) > new Date(Date.now() - 7*24*60*60*1000));
                if (week.length) {
                    const avg = week.reduce((s, r) => s + r.hb, 0) / week.length;
                    $('avg-7').textContent = avg.toFixed(2);
                }
            } else {
                const t = translations[state.lang];
                $('latest-reading').innerHTML = `<p class="text-gray-500">${t.noReadingsYet}</p>`;
            }
            
            const histDiv = $('history-cards');
            histDiv.innerHTML = state.history.length === 0 ? '<div class="glass-card p-6 rounded-3xl text-center text-gray-500">No history</div>' :
                state.history.map(r => `
                    <div class="glass-card p-4 rounded-3xl shadow-md flex items-center gap-4">
                        <img src="data:image/jpeg;base64,${r.crop}" class="w-24 h-20 object-cover rounded-xl">
                        <div class="flex-1">
                            <p class="font-semibold">${new Date(r.time).toLocaleDateString()}</p>
                            <p class="text-2xl font-bold text-cyan-600">${r.hb.toFixed(2)} g/dL</p>
                        </div>
                    </div>
                `).join('');
        }
        
        function updateChart() {
            if (state.history.length === 0) return;
            const ctx = $('chart').getContext('2d');
            const labels = state.history.map(r => new Date(r.time).toLocaleDateString()).reverse();
            const data = state.history.map(r => r.hb).reverse();
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{label: 'Hb (g/dL)', data, borderColor: '#0891b2', backgroundColor: 'rgba(8, 145, 178, 0.1)', tension: 0.4}]
                },
                options: {responsive: true, maintainAspectRatio: true}
            });
        }
        
        function handleFile(file) {
            if (!file) return;
            const url = URL.createObjectURL(file);
            $('image-to-crop').src = url;
            $('camera-modal').classList.add('hidden');
            $('crop-modal').classList.remove('hidden');
            if (cropper) cropper.destroy();
            cropper = new Cropper($('image-to-crop'), {
                aspectRatio: 16/9, viewMode: 1, dragMode: 'move', background: false, autoCropArea: 0.8
            });
        }
        
        async function analyze(b64) {
            $('loading-modal').classList.remove('hidden');
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({image_b64: b64})
                });
                if (!res.ok) throw new Error('Analysis failed');
                const data = await res.json();
                state.history.unshift({hb: data.hb_value, crop: data.crop_b64, time: new Date().toISOString()});
                localStorage.setItem('history', JSON.stringify(state.history));
                updateViews();
                showView('dashboard-view');
            } catch (err) {
                $('error-msg').textContent = err.message;
                $('error-modal').classList.remove('hidden');
            } finally {
                $('loading-modal').classList.add('hidden');
            }
        }
        
        function init() {
            const saved = localStorage.getItem('history');
            if (saved) state.history = JSON.parse(saved);
            
            const savedLang = localStorage.getItem('lang') || 'en';
            setLang(savedLang);
            
            $('lang-btn').onclick = () => setLang(state.lang === 'en' ? 'ar' : 'en');
            
            $('.nav-button').forEach(btn => {
                btn.onclick = () => showView(btn.dataset.view);
            });
            
            $('camera-btn').onclick = () => $('camera-modal').classList.remove('hidden');
            $('close-modal').onclick = () => $('camera-modal').classList.add('hidden');
            
            $('camera-input').onchange = (e) => handleFile(e.target.files[0]);
            $('upload-input').onchange = (e) => handleFile(e.target.files[0]);
            
            $('back-crop').onclick = () => {
                $('crop-modal').classList.add('hidden');
                $('camera-modal').classList.remove('hidden');
                if (cropper) cropper.destroy();
            };
            
            $('confirm-crop').onclick = () => {
                if (!cropper) return;
                const canvas = cropper.getCroppedCanvas({width: 800});
                const b64 = canvas.toDataURL('image/jpeg').split(',')[1];
                $('crop-modal').classList.add('hidden');
                if (cropper) cropper.destroy();
                analyze(b64);
            };
            
            $('close-error').onclick = () => $('error-modal').classList.add('hidden');
            
            $('articles').onclick = (e) => {
                const card = e.target.closest('.article-card');
                if (!card) return;
                const article = translations[state.lang].articles.find(a => a.id === card.dataset.id);
                if (!article) return;
                $('article-title').textContent = article.title;
                $('article-img').src = article.img;
                $('article-content').innerHTML = article.content;
                showView('article-view');
            };
            
            $('back-btn').onclick = () => showView('dashboard-view');
        }
        
        document.addEventListener('DOMContentLoaded', init);
    })();
    </script>
</body>
</html>